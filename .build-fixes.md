# Build Fixes Applied

## TypeScript Compilation Errors Fixed

### Issue 1: Unused `broadcast` parameter in session.handler.ts

**Error:**
```
src/handlers/session.handler.ts(21,3): error TS6133: 'broadcast' is declared but its value is never read.
```

**Fix:**
Removed the unused `broadcast` parameter from `handleSessionCreate` function.

**Files changed:**
- `services/doc-websocket/src/handlers/session.handler.ts` - Removed broadcast parameter
- `services/doc-websocket/src/websocket/server.ts` - Updated function call to not pass broadcast

### Issue 2: Type mismatch in syncSettings

**Error:**
```
src/handlers/session.handler.ts(31,7): error TS2322: Type '{ syncScroll?: boolean | undefined; syncPage?: boolean | undefined; syncHighlight?: boolean | undefined; } | undefined' is not assignable to type '{ syncScroll: boolean; syncPage: boolean; syncHighlight: boolean; } | undefined'.
```

**Root Cause:**
The `SessionCreatePayloadSchema` had sync settings with `.optional()` on each boolean field, but `CreateSessionInput` expected booleans with `.default(true)`. This created a type mismatch.

**Fix:**
Changed `SessionCreatePayloadSchema` to use `.default(true)` instead of `.optional()` for each boolean field in sync settings.

**File changed:**
- `services/doc-websocket/src/types/events.ts`

**Before:**
```typescript
syncSettings: z
  .object({
    syncScroll: z.boolean().optional(),
    syncPage: z.boolean().optional(),
    syncHighlight: z.boolean().optional(),
  })
  .optional(),
```

**After:**
```typescript
syncSettings: z
  .object({
    syncScroll: z.boolean().default(true),
    syncPage: z.boolean().default(true),
    syncHighlight: z.boolean().default(true),
  })
  .optional(),
```

## Additional Fixes

### Package Lock Files Generated

Created `package-lock.json` files for all services (required by Dockerfiles):
- `services/doc-api/package-lock.json`
- `services/doc-processor/package-lock.json`
- `services/doc-websocket/package-lock.json`

### Docker Build Issues Resolved

1. **BuildX Permission Error**: Updated test scripts to use legacy builder (`DOCKER_BUILDKIT=0`)
2. **Missing Lock Files**: Generated package-lock.json files for npm ci to work

## Verification

Run the test script to verify all services build and start correctly:

```bash
./test-stack.sh
```

The build should now complete without TypeScript errors.
